<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>새롬 통합관리시스템 · 전체 메뉴(심플)</title>
<style>
:root{ --bg:#ffffff; --ink:#0f172a; --muted:#64748b; --line:#e5e7eb; --panel:#f8fafc; --radius:14px; --shadow:0 10px 30px rgba(2,6,23,.06); }
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,'Noto Sans KR',Helvetica,Arial,'Apple SD Gothic Neo','맑은 고딕',sans-serif;color:var(--ink);background:var(--bg)}
header{position:sticky;top:0;z-index:20;padding:12px 16px;border-bottom:1px solid var(--line);background:#fff;font-weight:800}
.wrap{display:flex;justify-content:center;padding:16px}
.container{width:min(1200px,94vw)}
.card{background:#fff;border:1px solid var(--line);border-radius:14px;box-shadow:0 10px 30px rgba(2,6,23,.06);padding:10px}
h1{font-size:18px;margin:6px 0 10px}
.desc{color:var(--muted);font-size:13px;margin-bottom:6px}

/* 테이블 */
.table-wrap{overflow:auto;max-height:70vh;border:1px solid var(--line);border-radius:12px}
.table{width:100%;border-collapse:separate;border-spacing:0;min-width:1200px}
.table thead th{position:sticky;top:0;background:#f1f5f9;border-bottom:1px solid var(--line);padding:9px 10px;text-align:left;font-size:13px;z-index:10}
.table tbody td{border-bottom:1px solid var(--line);padding:9px 10px;vertical-align:top;font-size:13px;line-height:1.45;background:#fff}
.table tbody tr:nth-child(even) td{background:#fcfdff}
.table tbody tr:hover td{background:#f7fbff}

/* 좌측 컬럼 고정 */
.sticky-col-1{position:sticky;left:0;z-index:5;background:inherit}
.sticky-col-2{position:sticky;left:160px;z-index:5;background:inherit}
.sticky-shadow-right{box-shadow: 6px 0 8px -6px rgba(2,6,23,.12) inset}

/* 편집 */
.cell-edit{outline:1px dashed transparent}
.cell-edit:focus{outline-color:#cfe8ff;background:#f7fbff}

/* 경로 선택(심플) */
.path-simple{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
input[type="file"].pick{display:none}
label.pick-btn{border:1px solid var(--line);background:#fff;border-radius:10px;padding:6px 10px;font-size:12px;cursor:pointer}
label.pick-btn:hover{background:#eef6ff}
.path-preview{display:inline-flex;align-items:center;gap:8px}
.path-preview a{border:1px solid var(--line);border-radius:8px;padding:4px 8px;text-decoration:none}
.path-preview code{background:#f8fafc;padding:2px 6px;border-radius:8px;white-space:nowrap}

/* 버튼 */
.btn{border:1px solid var(--line);background:#fff;border-radius:10px;padding:8px 12px;font-size:13px;cursor:pointer}
.btn:hover{background:#eef6ff}
.btn-tiny{border:1px solid var(--line);background:#fff;border-radius:8px;padding:2px 6px;font-size:11px;cursor:pointer}
.btn-tiny:hover{background:#eef6ff}
.btn-del{border:1px solid var(--line);background:#fff;border-radius:8px;padding:4px 8px;cursor:pointer;font-size:12px}
.btn-del:hover{background:#ffecec;border-color:#ffd1d1}
.footer{display:flex;justify-content:flex-end;gap:8px;margin-top:10px}
.note{color:#64748b;font-size:12px;margin-top:6px}
</style>
</head>
<body>
<header>새롬 통합관리시스템 · 전체 메뉴(심플)</header>

<main class="wrap">
  <div class="container">
    <div class="card">
      <h1>전체 메뉴 구조</h1>
      <p class="desc">헤더 고정 · 1/2Depth 병합 · 2Depth 기준 행추가 · 경로 선택 미리보기 · 하단 저장(JSON)</p>

      <div class="table-wrap">
        <table class="table" id="menuTable" aria-label="전체 메뉴 표">
          <thead>
            <tr>
              <th style="width:160px" class="sticky-col-1 sticky-shadow-right">1 Depth</th>
              <th style="width:200px" class="sticky-col-2 sticky-shadow-right">2 Depth</th>
              <th style="width:220px">3 Depth</th>
              <th style="width:170px">화면</th>
              <th style="width:130px">기능</th>
              <th style="width:90px">유형</th>
              <th>경로(파일명) : 링크처리</th>
              <th style="width:110px">비고</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>

      <div class="footer">
        <button class="btn" id="btnSave">저장(JSON)</button>
      </div>
      <div class="note">※ 첫 저장 시 한 번 폴더를 선택하면, 그 이후부터는 그 폴더에 자동 저장됩니다. (미지원 브라우저는 다운로드로 저장)</div>
    </div>
  </div>
</main>

<script>
/* ===== 1) 메뉴 데이터(CSV) ===== */
const CSV = `
스마트체크,스마트체크,현황,스마트체크현황,현황,페이지,html/02_01_03.html
사업장관리,,,"관리 사업장",목록,페이지,html/05_01_01.html
사업장관리,사업장 등록/상세/수정,기본정보,기본정보,보기,페이지,html/05_01_02.html
사업장관리,사업장 등록/상세/수정,관리주체,관리주체,보기,페이지,html/05_01_02.html#t1
인사관리,근퇴관리,연차사용현황,연차사용현황,현황,페이지,html_bk/02_02_05_01_01_연차사용현황.html
인사관리,근퇴관리,경비원명부,경비원명부,현황,페이지,html_bk/02_03_03_01_경비원명부.html
`;

/* ===== 2) CSV 파싱 ===== */
function parseCSV(csv){
  return csv.split(/\r?\n/).map(l=>l.trim()).filter(l=>l).map(line=>{
    const parts = line.split(',');
    return {
      d1:parts[0]||'', d2:parts[1]||'', d3:parts[2]||'',
      screen:parts[3]||'', func:parts[4]||'', type:parts[5]||'',
      path:parts[6]||'', note:''
    };
  });
}
let DATA = parseCSV(CSV);

/* ===== 3) 렌더링/편집 ===== */
const tbody = document.getElementById('tbody');

function mkEditableCell(text){ const td=document.createElement('td'); td.className='cell-edit'; td.contentEditable='true'; td.textContent=text||''; return td; }

function render(){
  tbody.innerHTML='';
  DATA.forEach((row, idx)=>{
    const tr=document.createElement('tr'); tr.dataset.idx=idx;

    const td1=document.createElement('td'); td1.className='sticky-col-1 sticky-shadow-right d1'; td1.textContent=row.d1; tr.appendChild(td1);

    const td2=document.createElement('td'); td2.className='sticky-col-2 sticky-shadow-right d2';
    const wrap=document.createElement('div'); wrap.style.display='flex'; wrap.style.alignItems='center'; wrap.style.gap='6px';
    const span=document.createElement('span'); span.className='cell-edit'; span.contentEditable='true'; span.textContent=row.d2;
    const add=document.createElement('button'); add.className='btn-tiny'; add.textContent='+ 행추가';
    add.addEventListener('click', ()=> addRowAt2Depth(row.d1, (span.textContent||'').trim()||row.d2));
    wrap.appendChild(span); wrap.appendChild(add); td2.appendChild(wrap); tr.appendChild(td2);

    const td3=mkEditableCell(row.d3), tds=mkEditableCell(row.screen), tdf=mkEditableCell(row.func), tdt=mkEditableCell(row.type);
    tr.appendChild(td3); tr.appendChild(tds); tr.appendChild(tdf); tr.appendChild(tdt);

    // 경로 파일 선택 + 링크 미리보기
    const tdp=document.createElement('td'); const pwrap=document.createElement('div'); pwrap.className='path-simple';
    const inputId='file-'+idx; const label=document.createElement('label'); label.className='pick-btn'; label.setAttribute('for',inputId); label.textContent='파일 선택';
    const input=document.createElement('input'); input.type='file'; input.accept='.html'; input.id=inputId; input.className='pick';
    const preview=document.createElement('div'); preview.className='path-preview';
    function refresh(path,file){ preview.innerHTML=''; if(file){ const url=URL.createObjectURL(file); const a=document.createElement('a'); a.href=url; a.target='_blank'; a.textContent='열기'; const code=document.createElement('code'); code.textContent=file.webkitRelativePath||file.name; preview.appendChild(a); preview.appendChild(code);} else if(path){ const a=document.createElement('a'); a.href=path; a.target='_blank'; a.textContent='열기'; const code=document.createElement('code'); code.textContent=path; preview.appendChild(a); preview.appendChild(code);} else { const code=document.createElement('code'); code.textContent='(미지정)'; preview.appendChild(code);} }
    refresh(row.path);
    input.addEventListener('change', e=>{ const f=e.target.files&&e.target.files[0]; if(!f) return; DATA[idx].path=f.webkitRelativePath||f.name; refresh(DATA[idx].path, f); });
    pwrap.appendChild(label); pwrap.appendChild(input); pwrap.appendChild(preview); tdp.appendChild(pwrap); tr.appendChild(tdp);

    const tdn=document.createElement('td'); const del=document.createElement('button'); del.className='btn-del'; del.textContent='삭제'; del.addEventListener('click', ()=>{ DATA.splice(idx,1); render(); }); tdn.appendChild(del); tr.appendChild(tdn);

    [span,td3,tds,tdf,tdt].forEach(el=> el.addEventListener('blur', ()=>{ const i=parseInt(tr.dataset.idx,10); DATA[i].d2=span.textContent.trim(); DATA[i].d3=td3.textContent.trim(); DATA[i].screen=tds.textContent.trim(); DATA[i].func=tdf.textContent.trim(); DATA[i].type=tdt.textContent.trim(); applyRowspan(); toggleAddButtonsForMerged(); }));
    tbody.appendChild(tr);
  });
  applyRowspan(); toggleAddButtonsForMerged();
}

function applyRowspan(){
  mergeCol('d1'); mergeCol('d2');
  function mergeCol(cls){
    const cells=Array.from(tbody.querySelectorAll('td.'+cls));
    cells.forEach(c=>{ c.style.display=''; c.rowSpan=1; });
    let prev=null, span=1;
    Array.from(tbody.querySelectorAll('tr')).forEach(tr=>{
      const cell=tr.querySelector('td.'+cls);
      if(!prev){ prev=cell; span=1; return; }
      if(cell.textContent.trim()===prev.textContent.trim()){ cell.style.display='none'; prev.rowSpan=++span; }
      else{ prev=cell; span=1; }
    });
  }
}
function toggleAddButtonsForMerged(){
  Array.from(tbody.querySelectorAll('tr')).forEach(tr=>{
    const c=tr.querySelector('td.d2'); if(!c) return;
    const btn=c.querySelector('.btn-tiny'); if(!btn) return;
    btn.style.display = (c.style.display==='none') ? 'none' : 'inline-flex';
  });
}

function addRowAt2Depth(d1,d2){
  const useD2=d2||''; let insertIdx=-1;
  for(let i=DATA.length-1;i>=0;i--){ if(DATA[i].d1===d1 && DATA[i].d2===useD2){ insertIdx=i+1; break; } }
  const row={d1, d2:useD2, d3:'', screen:'', func:'', type:'페이지', path:'', note:''};
  if(insertIdx===-1) DATA.push(row); else DATA.splice(insertIdx,0,row);
  render();
}

/* ===== 4) 저장 — 같은 폴더에 저장 (File System Access API 사용) ===== */
let saveDirHandle = null;

async function ensureDirHandle(){
  // 이미 권한 있는 핸들이면 종료
  if (saveDirHandle && (await saveDirHandle.queryPermission({mode:'readwrite'})) === 'granted') return saveDirHandle;

  // 권한 요청/부여 확인
  if (saveDirHandle){
    const p = await saveDirHandle.requestPermission({mode:'readwrite'});
    if (p === 'granted') return saveDirHandle;
  }

  // 최초 또는 권한 거부 → 폴더 선택
  if ('showDirectoryPicker' in window){
    saveDirHandle = await window.showDirectoryPicker({id:'saerom-menu-save-dir'});
    return saveDirHandle;
  }
  return null; // 미지원
}

async function saveJSONToFolder(){
  const blob = new Blob([JSON.stringify(DATA, null, 2)], {type:'application/json'});
  const now = new Date();
  const y=now.getFullYear(), m=String(now.getMonth()+1).padStart(2,'0'), d=String(now.getDate()).padStart(2,'0'), hh=String(now.getHours()).padStart(2,'0'), mm=String(now.getMinutes()).padStart(2,'0');
  const filename = `menu_data_${y}${m}${d}_${hh}${mm}.json`;

  try{
    const dir = await ensureDirHandle();
    if (dir){
      const fileHandle = await dir.getFileHandle(filename, { create:true });
      const writable = await fileHandle.createWritable();
      await writable.write(blob);
      await writable.close();
      alert(`저장 완료: ${filename}`);
      return;
    }
  }catch(err){
    console.warn('폴더 저장 실패, 다운로드로 대체:', err);
  }

  // Fallback: 브라우저 다운로드
  const a=document.createElement('a');
  a.href=URL.createObjectURL(blob);
  a.download=filename;
  a.click();
}

document.getElementById('btnSave').addEventListener('click', saveJSONToFolder);

/* 초기 렌더 */
render();
</script>
</body>
</html>
